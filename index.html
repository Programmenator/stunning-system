<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OCR Scanner</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 10px; 
            height: 100dvh; 
            display: flex; 
            flex-direction: column; 
            background-color: #121212; 
            color: #fff;
            font-family: sans-serif;
            box-sizing: border-box;
            overflow: hidden; /* Prevents scrolling */
        }
        h2 { margin: 0 0 10px 0; text-align: center; font-size: 1.2rem; }
        
        #videoContainer {
            position: relative;
            width: 100%;
            flex: 1 1 50%;
            min-height: 0;
            border: 2px solid #444; 
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }
        video { 
            width: 100%; 
            height: 100%;
            object-fit: cover; 
            display: block;
        }
        #targetBox {
            position: absolute;
            top: 25%; left: 10%;
            width: 80%; height: 50%;
            border: 3px solid #00ff00;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            pointer-events: none;
        }

        #controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            height: 50px;
            flex-shrink: 0;
        }
        button { 
            flex: 1;
            font-size: 16px; 
            font-weight: bold;
            cursor: pointer; 
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
        }
        button:hover { background-color: #0056b3; }

        textarea {
            width: 100%; 
            flex: 1 1 40%;
            min-height: 0;
            padding: 10px;
            font-size: 16px;
            resize: none; /* Disabled to maintain layout */
            border: 2px solid #444; 
            border-radius: 8px;
            box-sizing: border-box;
            background: #1e1e1e;
            color: #fff;
        }
        canvas { display: none; }
    </style>
</head>
<body>

    <h2>Text Grabber</h2>
    
    <div id="videoContainer">
        <video id="camera" autoplay playsinline></video>
        <div id="targetBox"></div>
    </div>
    
    <div id="controls">
        <button id="captureBtn">Capture Text</button>
        <button id="saveBtn">Save File</button>
    </div>
    
    <textarea id="resultText" placeholder="Extracted text will appear here..."></textarea>
    <canvas id="canvas"></canvas>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        const video = document.getElementById('camera');
        const canvas = document.getElementById('canvas');
        const captureBtn = document.getElementById('captureBtn');
        const resultText = document.getElementById('resultText');
        const saveBtn = document.getElementById('saveBtn');
        const targetBox = document.getElementById('targetBox');

        // Initialize Camera
        navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 }, advanced: [{ focusMode: "continuous" }] }
        }).then(stream => { video.srcObject = stream; }).catch(() => {
            resultText.value = "Camera error. Check permissions.";
        });

        // Capture & OCR
        captureBtn.addEventListener('click', async () => {
            resultText.value = "Reading text... Please hold steady.";
            
            const scaleX = video.videoWidth / video.clientWidth;
            const scaleY = video.videoHeight / video.clientHeight;
            const cropX = targetBox.offsetLeft * scaleX;
            const cropY = targetBox.offsetTop * scaleY;
            const cropWidth = targetBox.offsetWidth * scaleX;
            const cropHeight = targetBox.offsetHeight * scaleY;

            canvas.width = cropWidth;
            canvas.height = cropHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.filter = 'grayscale(100%) contrast(250%) brightness(120%)';
            ctx.drawImage(video, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

            try {
                const result = await Tesseract.recognize(canvas, 'eng');
                let cleanedText = result.data.text.trim();
                resultText.value = cleanedText.length < 2 ? "No text found. Try again." : cleanedText;
            } catch (error) {
                resultText.value = "Error extracting text.";
            }
        });

        // Save
        saveBtn.addEventListener('click', () => {
            const text = resultText.value;
            if (!text || text.includes("Reading text...")) return;
            const blob = new Blob([text], { type: 'text/plain' });
            const anchor = document.createElement('a');
            anchor.href = URL.createObjectURL(blob);
            anchor.download = 'scanned_text.txt';
            anchor.click();
            URL.revokeObjectURL(anchor.href);
        });
    </script>
</body>
</html>
